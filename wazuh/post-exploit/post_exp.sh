#!/bin/bash

######################################################################
# This script manages Wazuh admin password hashes in internal_users.yml
#
# Usage (must be sourced):
#   source $0 set     # Generate and set new password 'wazuh', backup old hash
#   source $0 restore # Restore old hash from /tmp/back.txt
#
# Note: Always source this script (source ./script.sh) to avoid exit on 'exit'
######################################################################

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo "Please source this script instead of executing it"
    echo "Run with: source $0 [set|restore]"
    exit 1
fi

file="/etc/wazuh-indexer/opensearch-security/internal_users.yml"
backup="/tmp/back.txt"

if [ ! -f "$file" ]; then
    echo "File $file not found!"
    return 1
fi

if [ -z "$1" ]; then
    echo "Usage: source $0 [set|restore]"
    return 1
fi

case "$1" in
    set)
        # Backup old admin password hash
        awk '/^admin:/ {flag=1; next} /^[^ ]/ {flag=0} flag && /hash:/ {print $2}' "$file" > "$backup"
        if [ $? -ne 0 ]; then
            echo "Failed to backup old hash"
            return 1
        fi
        echo "Old admin password hash backed up to $backup"

        # Generate new bcrypt hash for password 'wazuh'
        HASH=$(htpasswd -bnBC 12 "" "Admin12345678" | cut -d ':' -f2- | tr -d '\n')
        if [ -z "$HASH" ]; then
            echo "Failed to generate bcrypt hash"
            return 1
        fi

        # Replace the hash line under admin block
        sed -ri "/^admin:/,/^[^ ]/ s|(^[[:space:]]*hash: ).*|\1$HASH|" "$file"
        echo "Admin password hash updated in $file"
        echo "New HASH: $HASH"
        ;;

    restore)
        if [ ! -f "$backup" ]; then
            echo "Backup file $backup not found!"
            return 1
        fi

        OLD_HASH=$(head -n 1 "$backup" | tr -d '\n')
        if [ -z "$OLD_HASH" ]; then
            echo "Old hash in $backup is empty!"
            return 1
        fi

        # Replace the hash line under admin block with old hash from backup
        sed -ri "/^admin:/,/^[^ ]/ s|(^[[:space:]]*hash: ).*|\1$OLD_HASH|" "$file"
        echo "Admin password hash restored from $backup into $file"
        ;;

    *)
        echo "Invalid option: $1"
        echo "Usage: source $0 [set|restore]"
        return 1
        ;;
esac

# Restart Wazuh services for changes to take effect
echo "Done."
