#!/bin/bash

#######################################
# This script deletes Wazuh logs from OpenSearch
# based on a specified time range and log level.
# It uses the OpenSearch REST API to perform the deletion.
#######################################


# ------ Configurable variables ------
OS_HOST="https://192.168.8.137:9200"
OS_USER="admin"
OS_PASS="your_password_here"
INDEX_PATTERN="wazuh-alerts-4.x-*"
MIN_LEVEL=6

usage() {
  echo ""
  echo "Usage: $0 <time_range>"
  echo ""
  echo "Description:"
  echo "  Deletes Wazuh logs from OpenSearch for the last given time range"
  echo "  where rule.level >= $MIN_LEVEL (default: 6)."
  echo ""
  echo "Arguments:"
  echo "  <time_range>   Time duration (e.g., 10m = 10 minutes, 2h = 2 hours, 1d = 1 day)"
  echo ""
  echo "Example:"
  echo "  $0 10m       # Delete logs from the last 10 minutes"
  echo "  $0 2h        # Delete logs from the last 2 hours"
  echo ""
  exit 1
}

if [[ "$1" == "--help" || "$1" == "-h" || -z "$1" ]]; then
  usage
fi

TIME_RANGE="$1"

if ! command -v curl >/dev/null 2>&1; then
  echo "Error: 'curl' is required but not installed."
  exit 1
fi

echo "Deleting logs from OpenSearch index '$INDEX_PATTERN'"
echo "Time range: now-$TIME_RANGE"
echo "Log level: rule.level >= $MIN_LEVEL"
echo ""

# ------ Main delete-by-query request -------
curl -X POST "$OS_HOST/$INDEX_PATTERN/_delete_by_query" -u "$OS_USER:$OS_PASS" -k \
  -H 'Content-Type: application/json' \
  -d '{
    "query": {
      "bool": {
        "must": [
          {
            "range": {
              "@timestamp": {
                "gte": "now-'"$TIME_RANGE"'"
              }
            }
          },
          {
            "range": {
              "rule.level": {
                "gte": '"$MIN_LEVEL"'
              }
            }
          }
        ]
      }
    }
  }'
